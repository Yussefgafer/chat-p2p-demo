name: Build All Chat P2P APK Versions

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job 1: Build Main Release APK
  build-main:
    name: Build Main Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Change to simple_chat directory
      run: cd simple_chat
      
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Main Release APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons
        
    - name: Rename Main APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/chat-p2p-main.apk
        
    - name: Upload Main APK
      uses: actions/upload-artifact@v4
      with:
        name: chat-p2p-main.apk
        path: simple_chat/build/app/outputs/flutter-apk/chat-p2p-main.apk
        retention-days: 30

  # Job 2: Build Ultra Simple APK
  build-ultra-simple:
    name: Build Ultra Simple APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Ultra Simple APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_ultra_simple.dart
        
    - name: Rename Ultra Simple APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/ultra-simple.apk
        
    - name: Upload Ultra Simple APK
      uses: actions/upload-artifact@v4
      with:
        name: ultra-simple.apk
        path: simple_chat/build/app/outputs/flutter-apk/ultra-simple.apk
        retention-days: 30

  # Job 3: Build Hello Test APK
  build-hello:
    name: Build Hello Test APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Hello Test APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_hello.dart
        
    - name: Rename Hello Test APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/hello-test.apk
        
    - name: Upload Hello Test APK
      uses: actions/upload-artifact@v4
      with:
        name: hello-test.apk
        path: simple_chat/build/app/outputs/flutter-apk/hello-test.apk
        retention-days: 30

  # Job 4: Build Infinix Minimal APK
  build-infinix-minimal:
    name: Build Infinix Minimal APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Infinix Minimal APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_infinix_minimal.dart
        
    - name: Rename Infinix Minimal APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/infinix-minimal.apk
        
    - name: Upload Infinix Minimal APK
      uses: actions/upload-artifact@v4
      with:
        name: infinix-minimal.apk
        path: simple_chat/build/app/outputs/flutter-apk/infinix-minimal.apk
        retention-days: 30

  # Job 5: Build Infinix Safe APK
  build-infinix-safe:
    name: Build Infinix Safe APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Infinix Safe APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_infinix_safe.dart
        
    - name: Rename Infinix Safe APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/infinix-safe.apk
        
    - name: Upload Infinix Safe APK
      uses: actions/upload-artifact@v4
      with:
        name: infinix-safe.apk
        path: simple_chat/build/app/outputs/flutter-apk/infinix-safe.apk
        retention-days: 30

  # Job 6: Create Release with All APKs
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-main, build-ultra-simple, build-hello, build-infinix-minimal, build-infinix-safe]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download All APKs
      uses: actions/download-artifact@v4
      with:
        path: apks/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-build-${{ github.run_number }}
        name: Chat P2P Demo v1.0.0 Build ${{ github.run_number }}
        body: |
          ğŸ‰ Chat P2P Demo - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†!

          ## ğŸ“± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØªØ§Ø­Ø©:

          ### ğŸ¥‡ Ù„Ù„Ù€ Infinix Hot 50I (Ù…ÙˆØµÙ‰ Ø¨Ù‡):
          - **infinix-minimal.apk** - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù€ Infinix
          - **infinix-safe.apk** - Ù†Ø³Ø®Ø© Ø¢Ù…Ù†Ø© Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
          - **ultra-simple.apk** - Ø§Ù„Ø£Ø¨Ø³Ø· ÙˆØ§Ù„Ø£ÙƒØ«Ø± ØªÙˆØ§ÙÙ‚Ø§Ù‹

          ### ğŸ¥ˆ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:
          - **hello-test.apk** - Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          - **chat-p2p-main.apk** - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©

          ## ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù‡Ø§ØªÙÙƒ
          2. ÙØ¹Ù„ "Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          3. Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          4. Ø§Ø³ØªÙ…ØªØ¹! ğŸ‰

          ## ğŸ”§ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
          - Android 5.0+ (API 21+)
          - 50MB Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ©

          ## ğŸš€ Ø§Ù„Ù…ÙŠØ²Ø§Øª:
          - âœ… ÙˆØ§Ø¬Ù‡Ø© Material Design 3
          - âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…
          - âœ… Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
          - âœ… Ù…Ø­Ø³Ù† Ù„Ù„Ù€ Infinix Hot 50I

          ---
          Built with â¤ï¸ using Flutter 3.24.0
        files: |
          apks/chat-p2p-main.apk/chat-p2p-main.apk
          apks/ultra-simple.apk/ultra-simple.apk
          apks/hello-test.apk/hello-test.apk
          apks/infinix-minimal.apk/infinix-minimal.apk
          apks/infinix-safe.apk/infinix-safe.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
