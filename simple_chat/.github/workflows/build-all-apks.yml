name: Build All Chat P2P APK Versions

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Job 1: Build Main Release APK
  build-main:
    name: Build Main Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Change to simple_chat directory
      run: cd simple_chat
      
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Main Release APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons
        
    - name: Rename Main APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/chat-p2p-main.apk
        
    - name: Upload Main APK
      uses: actions/upload-artifact@v4
      with:
        name: chat-p2p-main.apk
        path: simple_chat/build/app/outputs/flutter-apk/chat-p2p-main.apk
        retention-days: 30

  # Job 2: Build Ultra Simple APK
  build-ultra-simple:
    name: Build Ultra Simple APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Ultra Simple APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_ultra_simple.dart
        
    - name: Rename Ultra Simple APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/ultra-simple.apk
        
    - name: Upload Ultra Simple APK
      uses: actions/upload-artifact@v4
      with:
        name: ultra-simple.apk
        path: simple_chat/build/app/outputs/flutter-apk/ultra-simple.apk
        retention-days: 30

  # Job 3: Build Hello Test APK
  build-hello:
    name: Build Hello Test APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Hello Test APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_hello.dart
        
    - name: Rename Hello Test APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/hello-test.apk
        
    - name: Upload Hello Test APK
      uses: actions/upload-artifact@v4
      with:
        name: hello-test.apk
        path: simple_chat/build/app/outputs/flutter-apk/hello-test.apk
        retention-days: 30

  # Job 4: Build Infinix Minimal APK
  build-infinix-minimal:
    name: Build Infinix Minimal APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Infinix Minimal APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_infinix_minimal.dart
        
    - name: Rename Infinix Minimal APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/infinix-minimal.apk
        
    - name: Upload Infinix Minimal APK
      uses: actions/upload-artifact@v4
      with:
        name: infinix-minimal.apk
        path: simple_chat/build/app/outputs/flutter-apk/infinix-minimal.apk
        retention-days: 30

  # Job 5: Build Infinix Safe APK
  build-infinix-safe:
    name: Build Infinix Safe APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: Get dependencies
      run: |
        cd simple_chat
        flutter pub get
      
    - name: Build Infinix Safe APK
      run: |
        cd simple_chat
        flutter build apk --release --no-tree-shake-icons -t lib/main_infinix_safe.dart
        
    - name: Rename Infinix Safe APK
      run: |
        cd simple_chat
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/infinix-safe.apk
        
    - name: Upload Infinix Safe APK
      uses: actions/upload-artifact@v4
      with:
        name: infinix-safe.apk
        path: simple_chat/build/app/outputs/flutter-apk/infinix-safe.apk
        retention-days: 30

  # Job 6: Create Release with All APKs
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-main, build-ultra-simple, build-hello, build-infinix-minimal, build-infinix-safe]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download All APKs
      uses: actions/download-artifact@v4
      with:
        path: apks/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-build-${{ github.run_number }}
        name: Chat P2P Demo v1.0.0 Build ${{ github.run_number }}
        body: |
          🎉 Chat P2P Demo - جميع النسخ متاحة الآن!

          ## 📱 النسخ المتاحة:

          ### 🥇 للـ Infinix Hot 50I (موصى به):
          - **infinix-minimal.apk** - نسخة مبسطة مخصصة للـ Infinix
          - **infinix-safe.apk** - نسخة آمنة مع إعدادات محسنة
          - **ultra-simple.apk** - الأبسط والأكثر توافقاً

          ### 🥈 للاختبار:
          - **hello-test.apk** - اختبار سريع للتأكد من عمل التطبيق
          - **chat-p2p-main.apk** - النسخة الكاملة

          ## 📋 تعليمات التثبيت:
          1. حمل النسخة المناسبة لهاتفك
          2. فعل "مصادر غير معروفة" في الإعدادات
          3. ثبت التطبيق
          4. استمتع! 🎉

          ## 🔧 المتطلبات:
          - Android 5.0+ (API 21+)
          - 50MB مساحة فارغة

          ## 🚀 الميزات:
          - ✅ واجهة Material Design 3
          - ✅ الوضع المظلم
          - ✅ دعم اللغة العربية
          - ✅ محسن للـ Infinix Hot 50I

          ---
          Built with ❤️ using Flutter 3.24.0
        files: |
          apks/chat-p2p-main.apk/chat-p2p-main.apk
          apks/ultra-simple.apk/ultra-simple.apk
          apks/hello-test.apk/hello-test.apk
          apks/infinix-minimal.apk/infinix-minimal.apk
          apks/infinix-safe.apk/infinix-safe.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
